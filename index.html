<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Isochrone Mapping</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css" rel="stylesheet" />
    <link href='style.css' rel='stylesheet' />
    <!-- Import Assembly -->
    <link href='https://api.mapbox.com/mapbox-assembly/v0.23.2/assembly.min.css' rel='stylesheet'>
    <script src='https://api.mapbox.com/mapbox-assembly/v0.23.2/assembly.js'></script>
    <!-- Import jQuery -->
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
</head>

<body>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"
        type="text/css" />
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <div id="map"></div>
    <div id="output"></div>

    <div class='absolute fl my36 mx36 py36 px36 bg-gray-faint round'>
        <form id='params'>
            <h4 class='txt-m txt-bold mb6'>Chose a travel mode:</h4>
            <div class='mb12 mr12 toggle-group align-center'>
                <label class='toggle-container'>
                    <input name='profile' type='radio' value='walking' checked>
                    <div class='toggle toggle--active-null toggle--null'>Walking</div>
                </label>
                <label class='toggle-container'>
                    <input name='profile' type='radio' value='cycling'>
                    <div class='toggle toggle--active-null toggle--null'>Cycling</div>
                </label>
                <label class='toggle-container'>
                    <input name='profile' type='radio' value='driving'>
                    <div class='toggle toggle--active-null toggle--null'>Driving</div>
                </label>
            </div>
            <h4 class='txt-m txt-bold mb6'>Chose a maximum duration:</h4>
            <div class='mb12 mr12 toggle-group align-center'>
                <label class='toggle-container'>
                    <input name='duration' type='radio' value='10' checked>
                    <div class='toggle toggle--active-null toggle--null'>10 min</div>
                </label>
                <label class='toggle-container'>
                    <input name='duration' type='radio' value='20'>
                    <div class='toggle toggle--active-null toggle--null'>20 min</div>
                </label>
                <label class='toggle-container'>
                    <input name='duration' type='radio' value='30'>
                    <div class='toggle toggle--active-null toggle--null'>30 min</div>
                </label>
            </div>
            <h4 class='txt-m txt-bold mb6'>Choose an amenity:</h4>
            <div class='mb12 mr12 toggle-group align-center'>
                <label class='toggle-container'>
                    <input name='amenity' type='radio' value='cafe' checked>
                    <div class='toggle toggle--active-null toggle--null'>Cafes</div>
                </label>
                <label class='toggle-container'>
                    <input name='amenity' type='radio' value='restaurant'>
                    <div class='toggle toggle--active-null toggle--null'>Restaurants</div>
                </label>
                <label class='toggle-container'>
                    <input name='amenity' type='radio' value='bar'>
                    <div class='toggle toggle--active-null toggle--null'>Bars</div>
                </label>
            </div>
        </form>
    </div>

    
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoibm9ub3VtYXN5IiwiYSI6ImNrYTdtcGQwYTAzOGgycnBwc2F0dHdzdjYifQ.EzZeVp9SKvaRaCZm-i8JLg';

        // const transformRequest = (url) => {
        //     const hasQuery = url.indexOf("?") !== -1;
        //     const suffix = hasQuery ? "&pluginName=lunchboxIsochrones" : "?pluginName=lunchboxIsochrones";
        //     return {
        //         url: url + suffix
        //     }
        // }

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/nonoumasy/cka5z8wxh02fj1io05ee5ria4',
            center: [4.898506, 52.365503],
            zoom: 13,
            // transformRequest: transformRequest
        });

        //
        const isoUrl = "https://api.mapbox.com/isochrone/v1/mapbox";
        let profile = "walking";
        let minutes = "10";
        let amenity = "cafe";
        let coords = "4.898506, 52.365503";
        // let LngLat = coords

        let points = {}

        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Enter Booking Address'
            
        })

        //
        map.addControl(geocoder, "top-right");

        // Target the "params" form in the HTML portion of your code
        var params = document.getElementById('params');

        // When a user changes the value of profile or duration by clicking a button, change the parameter's value and make the API query again
        params.addEventListener('change', function (e) {
            if (e.target.name === 'profile') {
                profile = e.target.value
                getIso()
            } else if (e.target.name === 'duration') {
                minutes = e.target.value
                getIso()
            } else if (e.target.name === 'amenity') {
                amenity = e.target.value
                getIso()
            }
        })

        const getIso = function () {
            // Concatenate the request
            let request = `${isoUrl}/${profile}/${coords}.json?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`

            let pointsUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${amenity}.json?proximity=${coords}&access_token=${mapboxgl.accessToken}&limit=10    `

            // Fetch the point geojson and set it to a map layer source
            fetch(pointsUrl).then(res => res.json())
                .then(res => {
                    points = res
                    for (i = 0; i < points.features.length; i++) {
                            console.log(points.features[i].place_name)
                }
                map.getSource("points").setData(points)
            })

            // Make the request, then do the things
            fetch(request).then(res => res.json())
                .then(res => {
                let selected = turf.pointsWithinPolygon(points, res);
                map.getSource("selection").setData(selected);

                const selectionCount = selected.features.length;
                const message = `Number of ${amenity}s within ${minutes} minutes ${profile} of ${coords}: ${selectionCount}`
                document.getElementById("output").innerHTML = message;
            })

        }

        map.on("load", () => {

            // Initialize the marker at the query coordinates
            // marker.setLngLat(lngLat).addTo(map);

            // Add source and layer for the isochrone
            map.addSource("iso", {
                type: "geojson",
                data: {
                    type: "FeatureCollection",
                    features: []
                }
            })

            map.addLayer({
                "id": "isoLayer",
                "type": "fill",
                "source": "iso",
                "layout": {},
                "paint": {
                    "fill-color": "red",
                    "fill-opacity": 0.5
                }
            }, "poi-label")

            map.addLayer({
                "id": "isoBorder",
                "type": "line",
                "source": "iso",
                "layout": {},
                "paint": {
                    'line-color': '#191925',
                    'line-width': 3,
                    'line-dasharray': [2, 2]
                }
            }, "poi-label")

            // Add source and layer for the point data
            map.addSource("points", {
                type: "geojson",
                data: {
                    type: "FeatureCollection",
                    features: []
                }
            });

            map.addLayer({
                "id": "pointsLayer",
                "interactive": true,
                "type": "circle",
                "source": "points",
                "layout": {},
                "paint": {
                    'circle-radius': 5,
                    'circle-color': 'white',
                    'circle-stroke-color': 'black',
                    'circle-stroke-width': 3,
                }
            }, "poi-label");

            // Add source and layer for the selected point data
            map.addSource("selection", {
                type: "geojson",
                data: {
                    type: "FeatureCollection",
                    features: [
                    ]
                }
            });

            map.addLayer({
                "id": "selectionLayer",
                "type": "circle",
                "source": "selection",
                "layout": {},
                "paint": {
                    'circle-color': 'orange',
                }
            });

            // Do this when the geocoder returns a result
            geocoder.on("result", ev => {
                coords = ev.result.geometry.coordinates.join(",")

                getIso()
            })

            getIso()

        })  
    </script>
    <li>
        <li></li>
    </li>
</body>

</html>